workflows:
  version: 2.1
  build-and-release:
    jobs:
      build:
        filters:
          tags:
            only: /.*/

        docker:
          - image: circleci/openjdk:8-jdk-browsers

        environment:
          JVM_OPTS: -Xmx3G
          TERM: dumb

        steps:
          - checkout
          - run:
              name: Decode Keyring
              command: base64 -d <<< $SIGNING_KEYRING_DATA > "${SIGNING_KEYRING_LOCATION}"
          - run:
              name: Checksum
              command: echo gradle/build_components/* >> /tmp/components

          - restore_cache:
              keys:
                - v1-dependencies-{{ checksum "build.gradle" }}-{{ checksum "/tmp/components" }}
                - v1-dependencies--

          - run: ./gradlew dependencies

          - save_cache:
              paths:
                - ~/.m2
                - ~/.gradle/caches
              key: v1-dependencies-{{ checksum "build.gradle" }}-{{ checksum "/tmp/components" }}

          - run: ./gradlew build

      release:
        requires:
          - build

        filters:
          tags:
            only: /^v.*/
          branches:
            ignore: /.*/

        steps:
          - checkout
          - run: ./gradlew release